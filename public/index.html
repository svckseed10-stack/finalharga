<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Realtime Gold Price</title>

<style>
body {
  background:#111;
  color:#fff;
  font-family:Arial,sans-serif;
  display:flex;
  justify-content:center;
  align-items:center;
  height:100vh;
  margin:0;
}

.card {
  background:#1a1a1a;
  padding:20px 24px;
  border-radius:12px;
  width:360px;
  border:1px solid #222;
}

h1 {
  text-align:center;
  font-size:18px;
  margin-bottom:8px;
}

.time, #timestamp {
  text-align:center;
  color:#aaa;
  font-size:12px;
}

.row { margin-top:12px }
.label { color:#aaa; font-size:13px }
.value { font-size:22px; font-weight:700 }

.green { color:#4caf50 }
.red { color:#ff6b6b }

.fade {
  animation:pulse .25s ease-out;
}

@keyframes pulse {
  from { transform:scale(1.06); opacity:.3 }
  to { transform:scale(1); opacity:1 }
}
</style>
</head>

<body>
<div class="card">
  <h1>Realtime Gold Price</h1>
  <div id="time" class="time">--:--:--</div>

  <div class="row">
    <div class="label">Buying</div>
    <div id="buy" class="value">-</div>
  </div>

  <div class="row">
    <div class="label">Selling</div>
    <div id="sell" class="value">-</div>
  </div>

  <div id="timestamp">Last update: -</div>
</div>

<script>
/* =============================
   KONFIGURASI POLLING
============================= */
const FAST_INTERVAL = 200;      // agresif
const FAST_DURATION = 4000;     // 4 detik
const NORMAL_INTERVAL = 5000;   // normal (penentu 600â€“800/jam)

/* =============================
   STATE
============================= */
let poller = null;
let isFetching = false;
let lastTimestamp = null;

/* =============================
   UTIL
============================= */
const format = n => Number(n).toLocaleString("id-ID");

/* =============================
   JAM WIB
============================= */
setInterval(()=>{
  document.getElementById("time").innerText =
    new Date().toLocaleTimeString("id-ID",{hour12:false});
},1000);

/* =============================
   FETCH GOLD
============================= */
async function loadGold(){
  if(isFetching) return;
  isFetching = true;

  try{
    const r = await fetch("/api/gold",{cache:"no-store"});
    const d = await r.json();

    const ts = new Date(d.updated_at.replace(" ","T")).getTime();
    if(lastTimestamp && ts <= lastTimestamp) return;
    lastTimestamp = ts;

    const buyEl = document.getElementById("buy");
    const sellEl = document.getElementById("sell");

    buyEl.classList.add("fade");
    sellEl.classList.add("fade");

    buyEl.innerText = format(d.buying_rate);
    sellEl.innerText = format(d.selling_rate);

    document.getElementById("timestamp").innerText =
      "Last update: " + new Date(ts).toLocaleTimeString("id-ID",{hour12:false});

  }catch(e){
    console.error(e);
  }finally{
    isFetching = false;
  }
}

/* =============================
   POLLING CONTROL
============================= */
function startNormal(){
  clearInterval(poller);
  poller = setInterval(loadGold, NORMAL_INTERVAL);
}

function startAggressive(){
  clearInterval(poller);
  poller = setInterval(loadGold, FAST_INTERVAL);

  setTimeout(()=>{
    startNormal();
  }, FAST_DURATION);
}

/* =============================
   INIT (PAGE LOAD / REFRESH)
============================= */
loadGold();        // fetch langsung
startAggressive(); // agresif hanya di awal
</script>
</body>
</html>
